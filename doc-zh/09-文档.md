````markdown
# 生成文档

有很多[方法](https://documentation.divio.com/)可以帮助他人开始使用我们的项目和库。例如，我们可以编写教程、提供可运行的示例、描述系统内部结构以及创建 API 参考。

在本章中，我们将重点介绍如何使用 [Haddock](https://haskell-haddock.readthedocs.io/en/latest/) 从带注释的 Haskell 源代码生成 API 参考页面（就像在 Hackage 上看到的那种）。

## 运行 Haddock

我们可以使用我们喜欢的包管理器为我们的项目生成 API 参考页面（在 Haskell 世界中也称为 haddocks）：

### Cabal

我们可以运行 `cabal haddock` 来生成 haddocks：

```sh
➜ cabal haddock
Resolving dependencies...
Build profile: -w ghc-9.0.1 -O1
In order, the following will be built (use -v for more details):
 - hs-blog-0.1.0.0 (lib) (first run)
Configuring library for hs-blog-0.1.0.0..
Preprocessing library for hs-blog-0.1.0.0..
Running Haddock on library for hs-blog-0.1.0.0..
Haddock coverage:
   0% (  0 /  3) in 'HsBlog.Env'
  Missing documentation for:
    Module header
    Env (src/HsBlog/Env.hs:3)
    defaultEnv (src/HsBlog/Env.hs:10)
  21% (  7 / 33) in 'HsBlog.Html.Internal'
  Missing documentation for:
    Module header
    Html (src/HsBlog/Html/Internal.hs:8)
...
Documentation created:
/tmp/learn-haskell-blog-generator/dist-newstyle/build/x86_64-linux/ghc-9.0.1/hs-blog-0.1.0.0/doc/html/hs-blog/index.html
```

Cabal 和 Haddock 将为我们构建项目并在此处生成 HTML 页面：

```html
./dist-newstyle/build/<platform>/<compiler>/<package>-<version>/doc/html/<package>/
```

然后，我们可以在 Web 浏览器中打开该目录下的 `index.html` 文件，查看我们的包文档。

### Stack

我们可以运行 `stack haddock` 来生成 haddocks：

```sh
➜ stack haddock
...
hs-blog> build (lib + exe)
Preprocessing library for hs-blog-0.1.0.0..
Building library for hs-blog-0.1.0.0..
[1 of 7] Compiling HsBlog.Env
[2 of 7] Compiling HsBlog.Html.Internal
...
hs-blog> haddock
Preprocessing library for hs-blog-0.1.0.0..
Running Haddock on library for hs-blog-0.1.0.0..
Haddock coverage:
   0% (  0 /  3) in 'HsBlog.Env'
  Missing documentation for:
    Module header
    Env (src/HsBlog/Env.hs:3)
    defaultEnv (src/HsBlog/Env.hs:10)
  21% (  7 / 33) in 'HsBlog.Html.Internal'
  Missing documentation for:
    Module header
    Html (src/HsBlog/Html/Internal.hs:8)
...
Documentation created:
.stack-work/dist/x86_64-linux-tinfo6/Cabal-3.2.1.0/doc/html/hs-blog/index.html,
.stack-work/dist/x86_64-linux-tinfo6/Cabal-3.2.1.0/doc/html/hs-blog/hs-blog.txt
Preprocessing executable 'hs-blog-gen' for hs-blog-0.1.0.0..
...
```

Stack 和 Haddock 将为我们构建项目并在此处生成 HTML 页面：

```html
./.stack-work/dist/<platform>/Cabal-<version>/doc/html/<package>/
```

然后，我们可以在 Web 浏览器中打开该目录下的 `index.html` 文件，查看我们的包文档。

### Haddock 覆盖率

Haddock 在运行时还会输出一份覆盖率报告，并指出缺少文档的用户公开构造。这些构造可能是模块头、类型、数据构造函数、类型类、函数、值等。

例如：

```hs
Haddock coverage:
...
   0% (  0 /  3) in 'HsBlog.Convert'
  Missing documentation for:
    Module header
    convert (src/HsBlog/Convert.hs:8)
    convertStructure (src/HsBlog/Convert.hs:23)
  67% (  2 /  3) in 'HsBlog.Directory'
  Missing documentation for:
    buildIndex (src/HsBlog/Directory.hs:80)
...
```

我们可以看到，我们根本没有为 `HsBlog.Convert` 编写文档，并且缺少模块头、`convert` 函数和 `convertStructure` 函数的文档。

另一方面，`HsBlog.Directory` 模块似乎确实有一些文档！我们将看到原因，但首先——尝试生成 haddocks，访问模块层次结构，浏览不同的模块，跟踪类型的链接，想象一下这个 API 参考可能是什么样子，然后让我们看看如何改进它。

## Haddock 标记

Haddock 通过构建我们的项目、检查导出的模块及其导出的定义，并抓取以特殊标记格式编写的源代码注释来构建 API 参考页面。

让我们快速看一下这种标记格式。我们将介绍一些重要的部分，但如果您想了解更多信息，可以在 [Haddock 文档](https://haskell-haddock.readthedocs.io/en/latest/markup.html)中找到 Haddock 标记的完整指南。


### 文档化定义

所有 haddock 注释都作为常规 Haskell 注释的一部分出现。它们可以与单行形式 (`--`) 和多行形式 (`{-` 和 `-}`) 一起使用。注释块的位置和 haddock 标记决定了 haddock 字符串附加到哪个 Haskell 定义。

我们可以通过在定义*之前*编写一个以 `|` 为前缀的注释块，或者在定义*之后*编写一个以 `^` 为前缀的注释块来注释 Haskell 定义。

例如：

```hs
-- | 从 `Head` 和 `Structure`
--   构造一个 HTML 页面。
html_
  :: Head -- ^ 表示 HTML 文件中的 @<head>@ 部分
  -> Structure -- ^ 表示 HTML 文件中的 @<body>@ 部分
  -> Html
html_ = ...
...
```

这是另一个例子：

```hs
{- | 表示单个标记结构。例如：

- 一个段落
- 一个无序列表
- 一个代码块
-}
data Structure
  = Heading Natural String
  -- ^ 带级别的章节标题
  | Paragraph String
  -- ^ 一个段落
  | UnorderedList [String]
  -- ^ 字符串的无序列表
  | OrderedList [String]
  -- ^ 字符串的有序列表
  | CodeBlock [String]
  -- ^ 一个代码块
```

还有一个：

```hs
{- | 标记到 HTML 的转换模块。

该模块处理将用我们的自定义标记语言编写的文档
转换为 HTML 页面。
-}
module HsBlog.Convert where
```

如您所见，`|` 和 `^` 可用于文档化函数、函数参数、类型、数据构造函数、模块等。它们可能是需要记住的最重要的 Haddock 注释（即便如此，仅 `|` 就足够了）。

> **提示**：至少用一些关于它们用途的高级描述来注释从您的项目中导出的模块、类型和顶级定义。
>
> 您的用户和合作者会感谢您的！

### 章节标题

我们可以通过添加标题将模块分成几个部分。标题是带有多个 `*` 前缀的注释（就像我们的标记语言一样）。

例如：

```hs
-- * HTML EDSL

html_ :: Head -> Structure -> Html
html_ = ...

-- ** 结构

p_ :: Content -> Structure
p_ = ..

h_ :: Content -> Structure
h_ = ..

...

-- ** 内容

txt_ :: String -> Content
txt_ = ...

link_ :: FilePath -> Content -> Content
link_ = ...
```

也可以将标题添加到导出列表中：

```hs
module HsBlog.Html
  ( -- * HTML EDSL
    Html
  , html_

    -- ** 用于构造 @<head>@ 部分的组合子
  , Head
  , title_
  , stylesheet_
  , meta_

    -- ** 用于构造 @<body>@ 部分的组合子
  , Structure
  , p_
  , h_
  , ul_
  , ol_
  , code_

    -- ** 用于在结构内部构造内容的组合子
  , Content
  , txt_
  , img_
  , link_
  , b_
  , i_

    -- ** 将 HTML 渲染为字符串
  , render
  )
  where
```

将模块的各个部分分成几部分有助于将重要的东西放在一起，Haddock 也会在模块页面的顶部为我们创建一个目录。

有时，在使用标题将其分成几个部分后，也更容易确定一个模块是否应该拆分成多个模块。

---

**练习**：尝试根据自己的喜好重新排列我们项目中的模块，并为各个部分添加标题。

---

### 格式化

如前所述，我们还可以在注释内容中添加格式。例如，我们可以：

- 通过用 `` ` `` 将标识符括起来来超链接它们

  例如：`` `Heading` ``
- 通过用 `@` 将其括起来来编写 `等宽文本`

  例如：`@Paragraph "Hello"@`
- 通过用 `/` 将其括起来来为文本添加 _强调_

  例如：`/this is emphasised/`
- 通过用 `__` 将其括起来来为文本添加 __粗体__

  例如：`__this is bold__`

### 更多

在本章中，我们介绍了 Haddock 标记语言的基础知识。如果您想了解更多信息，[Haddock 标记指南](https://haskell-haddock.readthedocs.io/en/latest/markup.html)包含了有关创建更有趣的文档结构（例如代码块、网格、表格、图像和示例）的信息。

## 总结

我们简要介绍了一下文档化 Haskell 程序的一个方面：使用 Haddock 从带有 Haddock 标记注释的源代码注释生成信息丰富的 API 参考页面。

虽然 API 参考非常有价值，但请记住，还有其他形式的文档可以帮助您的用户快速入门，例如示例和教程。


---

**练习**：为我们项目中的顶级定义添加 haddock 注释，并测试您对程序和各个部分的理解——有时，学习某件事的最好方法是尝试解释它！

---
````